<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Report - {% if customer_report %}{{ customer_report.meta.customer_id|mask_id }}{% elif bureau_report %}{{ bureau_report.meta.customer_id|mask_id }}{% endif %}</title>
    <script>{% autoescape false %}{% include 'chart.min.js' %}{% endautoescape %}</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .header {
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            color: #666;
            font-size: 13px;
        }

        .header-meta span {
            display: inline-block;
        }

        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .section h3 {
            color: #2c3e50;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .summary-box {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
        }

        .summary-box p {
            margin: 0;
            color: #444;
            white-space: pre-line;
        }

        .absence-note {
            background-color: #fdf2f2;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            color: #b44;
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .amount {
            text-align: right;
            font-family: 'Consolas', monospace;
        }

        .center {
            text-align: center;
        }

        .positive {
            color: #27ae60;
        }

        .negative {
            color: #e74c3c;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .info-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .info-item {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .info-item .value.risk {
            color: #e74c3c;
        }

        .info-item .value.safe {
            color: #27ae60;
        }

        .secured-yes {
            color: #27ae60;
            font-weight: 600;
        }

        .secured-no {
            color: #e67e22;
            font-weight: 600;
        }

        .section-divider {
            margin: 40px 0;
            padding: 12px 20px;
            background-color: #2c3e50;
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            border-radius: 4px;
        }

        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            color: #999;
            font-size: 11px;
        }

        /* ── charts ────────────────────────────── */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 10px;
        }

        .chart-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px 12px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-card h4 {
            font-size: 13px;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 700;
        }

        .chart-card canvas {
            max-width: 220px;
            max-height: 220px;
        }

        .chart-timeseries {
            grid-column: 1 / -1;
            width: 100%;
        }

        .chart-timeseries canvas {
            max-width: 100% !important;
            max-height: none !important;
            width: 100% !important;
            height: 420px !important;
        }

        @media print {
            body {
                padding: 0;
            }
            .section {
                page-break-inside: avoid;
            }
            .section-divider {
                page-break-before: always;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Combined Financial & Bureau Report</h1>
        <div class="header-meta">
            {% if customer_report %}
            <span><strong>Customer ID:</strong> {{ customer_report.meta.customer_id|mask_id }}</span>
            {% if customer_report.meta.prty_name %}
            <span><strong>Name:</strong> {{ customer_report.meta.prty_name }}</span>
            {% endif %}
            <span><strong>Generated:</strong> {{ customer_report.meta.generated_at[:10] }}</span>
            <span><strong>Period:</strong> {{ customer_report.meta.analysis_period }}</span>
            <span><strong>Transactions:</strong> {{ customer_report.meta.transaction_count }}</span>
            {% elif bureau_report %}
            <span><strong>Customer ID:</strong> {{ bureau_report.meta.customer_id|mask_id }}</span>
            <span><strong>Generated:</strong> {{ bureau_report.meta.generated_at[:10] }}</span>
            {% endif %}
            {% if bureau_report %}
            <span><strong>Tradelines:</strong> {{ bureau_report.executive_inputs.total_tradelines }}</span>
            {% endif %}
        </div>
    </div>

    {# ================================================================== #}
    {# PART 1: BUREAU REPORT                                               #}
    {# ================================================================== #}

    <div class="section-divider">Bureau Tradeline Analysis</div>

    {% if bureau_report %}

    <!-- Portfolio Summary -->
    <div class="section">
        <h3>Portfolio Summary</h3>
        <div class="info-grid">
            <div class="info-item">
                <label>Total / Live Tradelines</label>
                <div class="value">{{ bureau_report.executive_inputs.total_tradelines }} / {{ bureau_report.executive_inputs.live_tradelines }}</div>
            </div>
            <div class="info-item">
                <label>Total Sanction Amount</label>
                <div class="value">INR {{ bureau_report.executive_inputs.total_sanctioned|inr_units }}</div>
            </div>
            <div class="info-item">
                <label>Total Outstanding</label>
                <div class="value">
                    INR {{ bureau_report.executive_inputs.total_outstanding|inr_units }}
                    {% if bureau_report.executive_inputs.total_sanctioned > 0 %}
                        <span style="font-size: 13px; color: #666; font-weight: 400;">({{ "%.0f"|format(bureau_report.executive_inputs.total_outstanding / bureau_report.executive_inputs.total_sanctioned * 100) }}% of sanctioned)</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <label>Unsecured Sanction Amount</label>
                <div class="value">
                    INR {{ bureau_report.executive_inputs.unsecured_sanctioned|inr_units }}
                    {% if bureau_report.executive_inputs.total_sanctioned > 0 %}
                        <span style="font-size: 13px; color: #666; font-weight: 400;">({{ "%.0f"|format(bureau_report.executive_inputs.unsecured_sanctioned / bureau_report.executive_inputs.total_sanctioned * 100) }}% of total)</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <label>Unsecured Outstanding</label>
                <div class="value">
                    INR {{ bureau_report.executive_inputs.unsecured_outstanding|inr_units }}
                    <span style="font-size: 13px; color: #666; font-weight: 400;">
                        {% if bureau_report.executive_inputs.total_outstanding > 0 %}
                            ({{ "%.0f"|format(bureau_report.executive_inputs.unsecured_outstanding / bureau_report.executive_inputs.total_outstanding * 100) }}% of outstanding
                        {% endif %}
                        {% if bureau_report.executive_inputs.total_sanctioned > 0 %}
                            {% if bureau_report.executive_inputs.total_outstanding > 0 %} | {% else %}({% endif %}{{ "%.0f"|format(bureau_report.executive_inputs.unsecured_outstanding / bureau_report.executive_inputs.total_sanctioned * 100) }}% of sanctioned)
                        {% elif bureau_report.executive_inputs.total_outstanding > 0 %}
                            )
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="info-item">
                <label>Max DPD</label>
                <div class="value {% if bureau_report.executive_inputs.max_dpd and bureau_report.executive_inputs.max_dpd > 30 %}risk{% endif %}">
                    {% if bureau_report.executive_inputs.max_dpd is not none %}
                        {{ bureau_report.executive_inputs.max_dpd }}
                        {% if bureau_report.executive_inputs.max_dpd_months_ago is not none or bureau_report.executive_inputs.max_dpd_loan_type %}
                            <span style="font-size: 12px; color: #666;">({% if bureau_report.executive_inputs.max_dpd_months_ago is not none %}{{ bureau_report.executive_inputs.max_dpd_months_ago }} months ago{% endif %}{% if bureau_report.executive_inputs.max_dpd_months_ago is not none and bureau_report.executive_inputs.max_dpd_loan_type %}, {% endif %}{% if bureau_report.executive_inputs.max_dpd_loan_type %}{{ bureau_report.executive_inputs.max_dpd_loan_type }}{% endif %})</span>
                        {% endif %}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Visualizations -->
    {% if chart_data %}
    <div class="section">
        <h3>Portfolio Visualizations</h3>
        <div class="charts-grid">
            <div class="chart-card">
                <h4>Product Mix by Count</h4>
                <canvas id="cmbChartProductMix" width="220" height="220"></canvas>
            </div>
            <div class="chart-card">
                <h4>Secured vs Unsecured</h4>
                <canvas id="cmbChartSecured" width="220" height="220"></canvas>
            </div>
            <div class="chart-card">
                <h4>On-Us vs Off-Us</h4>
                <canvas id="cmbChartOnUs" width="220" height="220"></canvas>
            </div>
            <!-- 4. Unsecured Outstanding by Product -->
            <div class="chart-card">
                <h4>Unsecured Outstanding by Product</h4>
                <canvas id="cmbChartUnsecOut" width="220" height="220"></canvas>
            </div>

            <!-- 5. Portfolio Exposure Over Time (full-width stacked area chart) -->
            <div class="chart-card chart-timeseries">
                <h4>Portfolio Exposure Over Time (Stacked by Product)</h4>
                <canvas id="cmbChartTimeseries"></canvas>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // Fixed per-product color map — consistent across ALL charts.
        // Keys: short enum names (timeseries) AND display names (donuts).
        const PRODUCT_COLORS = {
            // Short names
            "PL":   "#4E79A7", "CC":   "#F28E2B", "HL":   "#59A14F",
            "AL":   "#E15759", "BL":   "#B07AA1", "LAP":  "#9C755F",
            "LAS":  "#86BCB6", "LAD":  "#D37295", "GL":   "#EDC948",
            "TWL":  "#76B7B2", "CD":   "#FF9DA7", "CMVL": "#A0CBE8",
            "OTHER":"#BAB0AC",
            // Display names (donuts receive these from Python)
            "Personal Loan":          "#4E79A7",
            "Credit Card":            "#F28E2B",
            "Home Loan":              "#59A14F",
            "Auto Loan":              "#E15759",
            "Business Loan":          "#B07AA1",
            "LAP":                    "#9C755F",
            "LAS":                    "#86BCB6",
            "LAD":                    "#D37295",
            "Gold Loan":              "#EDC948",
            "Two Wheeler Loan":       "#76B7B2",
            "Consumer Durable":       "#FF9DA7",
            "Commercial Vehicle Loan":"#A0CBE8",
            "Other":                  "#BAB0AC",
        };
        const FALLBACK_PALETTE = [
            "#4E79A7","#F28E2B","#59A14F","#E15759","#B07AA1",
            "#9C755F","#86BCB6","#D37295","#EDC948","#76B7B2",
            "#FF9DA7","#A0CBE8","#BAB0AC"
        ];
        const productColor = (name, idx) => PRODUCT_COLORS[name] || FALLBACK_PALETTE[idx % FALLBACK_PALETTE.length];

        const SECURED_COLORS = ["#27ae60","#e67e22"];
        const ONUS_COLORS    = ["#8e44ad","#1abc9c"];

        const COMMON_OPTS = {
            responsive: false,
            plugins: {
                legend: { position: "bottom", labels: { font: { size: 11 }, boxWidth: 12, padding: 8 } },
                tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed}` } }
            },
        };

        // colorFn(label, index) → hex color string
        function mkDonut(canvasId, labels, values, colorFn) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            const filtered = labels.map((l, i) => [l, values[i], colorFn(l, i)])
                                   .filter(x => x[1] > 0);
            if (!filtered.length) { ctx.parentElement.innerHTML += "<p style='color:#aaa;font-size:12px;'>No data</p>"; return; }
            new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: filtered.map(x => x[0]),
                    datasets: [{ data: filtered.map(x => x[1]), backgroundColor: filtered.map(x => x[2]),
                                 borderWidth: 2, borderColor: "#fff", hoverOffset: 6 }]
                },
                options: { ...COMMON_OPTS, cutout: "55%" }
            });
        }

        const CD = {{ chart_data | safe }};
        mkDonut("cmbChartProductMix", CD.product_mix.labels,   CD.product_mix.values,   productColor);
        mkDonut("cmbChartSecured",    CD.secured_split.labels, CD.secured_split.values, (_, i) => SECURED_COLORS[i % SECURED_COLORS.length]);
        mkDonut("cmbChartOnUs",       CD.onus_offus.labels,    CD.onus_offus.values,    (_, i) => ONUS_COLORS[i % ONUS_COLORS.length]);

        // Unsecured outstanding donut — product colors + INR-formatted tooltip
        (function() {
            const uo = CD.unsec_outstanding;
            const ctx = document.getElementById("cmbChartUnsecOut");
            if (!ctx) return;
            if (!uo || !uo.labels.length) { ctx.parentElement.innerHTML += "<p style='color:#aaa;font-size:12px;'>No data</p>"; return; }
            const fmt = v => v >= 1e7 ? (v/1e7).toFixed(2)+" Cr" : v >= 1e5 ? (v/1e5).toFixed(2)+" L" : String(v);
            new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: uo.labels,
                    datasets: [{ data: uo.values, backgroundColor: uo.labels.map(productColor),
                                 borderWidth: 2, borderColor: "#fff", hoverOffset: 6 }]
                },
                options: {
                    ...COMMON_OPTS, cutout: "55%",
                    plugins: {
                        legend: COMMON_OPTS.plugins.legend,
                        tooltip: { callbacks: { label: c => ` ${c.label}: ${fmt(c.parsed)}` } },
                    },
                },
            });
        })();

        // Stacked area chart — portfolio exposure over time, product colors
        (function() {
            const ts = CD.timeseries;
            const ctx = document.getElementById("cmbChartTimeseries");
            if (!ctx || !ts || !ts.months.length) return;
            const fmt = v => v >= 1e7 ? (v/1e7).toFixed(2)+" Cr" : v >= 1e5 ? (v/1e5).toFixed(2)+" L" : String(v);
            // Sort largest exposure to bottom of stack (most stable base)
            const entries = Object.entries(ts.series)
                .map(([name, vals]) => [name, vals, vals.reduce((a, b) => a + b, 0)])
                .sort((a, b) => b[2] - a[2]);
            const datasets = entries.map(([name, vals], i) => {
                const col = productColor(name, i);
                return {
                    label: name, data: vals,
                    borderColor: col, backgroundColor: col + "BB",
                    tension: 0.3, fill: true, pointRadius: 0, pointHoverRadius: 4, borderWidth: 2,
                };
            });
            new Chart(ctx, {
                type: "line",
                data: { labels: ts.months, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: "index", intersect: false },
                    plugins: {
                        legend: { position: "top", labels: { font: { size: 10 }, boxWidth: 12, padding: 10 } },
                        tooltip: {
                            callbacks: {
                                label: c => ` ${c.dataset.label}: ${fmt(c.parsed.y)}`,
                                footer: items => `Total: ${fmt(items.reduce((s, c) => s + c.parsed.y, 0))}`,
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { font: { size: 9 }, maxRotation: 45, autoSkip: true, maxTicksLimit: 12 } },
                        y: { stacked: true, ticks: { font: { size: 10 }, callback: fmt, maxTicksLimit: 9 }, beginAtZero: true },
                    },
                },
            });
        })();
    })();
    </script>
    {% endif %}

    <!-- Bureau Executive Summary -->
    {% if bureau_report.narrative %}
    <div class="section">
        <h3>Bureau Executive Summary</h3>
        <div class="summary-box">
            <p>{{ bureau_report.narrative }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Key Findings & Inferences -->
    {% if key_findings %}
    <div class="section">
        <h3>Key Findings & Inferences</h3>
        <div style="margin-top: 10px;">
            {% for finding in key_findings %}
            <div style="display: flex; align-items: flex-start; margin-bottom: 10px; padding: 10px; border-left: 4px solid {% if finding.severity == 'high_risk' %}#e74c3c{% elif finding.severity == 'moderate_risk' %}#e67e22{% elif finding.severity == 'concern' %}#f39c12{% elif finding.severity == 'positive' %}#27ae60{% else %}#95a5a6{% endif %}; background-color: #f8f9fa; border-radius: 0 4px 4px 0;">
                <div style="flex: 1;">
                    <div style="margin-bottom: 4px;">
                        <span style="font-size: 11px; color: #666;">{{ finding.category }}</span>
                    </div>
                    <div style="font-weight: 600; color: #2c3e50; font-size: 13px;">{{ finding.finding }}</div>
                    <div style="color: #555; font-size: 12px; margin-top: 3px; font-style: italic;">{{ finding.inference }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Product-wise Breakdown -->
    {% if vectors_data %}
    <div class="section">
        <h3>Product-wise Breakdown</h3>
        <table>
            <thead>
                <tr>
                    <th>Loan Type</th>
                    <th class="center">Secured</th>
                    <th class="center">Count</th>
                    <th class="center">Live</th>
                    <th class="center">Closed</th>
                    <th class="amount">Sanctioned</th>
                    <th class="amount">Outstanding</th>
                    <th class="center">Max DPD</th>
                    <th class="center">Util %</th>
                    <th class="center">On-Us</th>
                </tr>
            </thead>
            <tbody>
                {% for vec in vectors_data %}
                <tr>
                    <td>{{ vec.loan_type_display }}</td>
                    <td class="center {% if vec.secured %}secured-yes{% else %}secured-no{% endif %}">
                        {{ "Yes" if vec.secured else "No" }}
                    </td>
                    <td class="center">{{ vec.loan_count }}</td>
                    <td class="center">{{ vec.live_count }}</td>
                    <td class="center">{{ vec.closed_count }}</td>
                    <td class="amount">{{ vec.total_sanctioned_amount|inr }}</td>
                    <td class="amount">{{ vec.total_outstanding_amount|inr }}</td>
                    <td class="center">{{ vec.max_dpd if vec.max_dpd is not none else "-" }}</td>
                    <td class="center">{{ "{:.0f}".format(vec.utilization_ratio * 100) if vec.utilization_ratio is not none else "-" }}</td>
                    <td class="center">{{ vec.on_us_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Behavioral & Risk Features -->
    {% if tl_features %}
    <div class="section">
        <h3>Behavioral & Risk Features</h3>

        <h4 style="color: #2c3e50; margin: 15px 0 8px 0; font-size: 14px;">Loan Activity</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>Months Since Last PL Trade</label>
                <div class="value">{{ "%.2f"|format(tl_features.months_since_last_trade_pl) if tl_features.months_since_last_trade_pl is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Months Since Last Unsecured Trade</label>
                <div class="value">{{ "%.2f"|format(tl_features.months_since_last_trade_uns) if tl_features.months_since_last_trade_uns is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>New PL Trades (6M)</label>
                <div class="value">{{ tl_features.new_trades_6m_pl if tl_features.new_trades_6m_pl is not none else "N/A" }}</div>
            </div>
        </div>

        <h4 style="color: #2c3e50; margin: 15px 0 8px 0; font-size: 14px;">DPD & Delinquency</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>Max DPD 6M (CC)</label>
                <div class="value {% if tl_features.max_dpd_6m_cc is not none and tl_features.max_dpd_6m_cc > 0 %}risk{% else %}safe{% endif %}">
                    {{ tl_features.max_dpd_6m_cc if tl_features.max_dpd_6m_cc is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>Max DPD 6M (PL)</label>
                <div class="value {% if tl_features.max_dpd_6m_pl is not none and tl_features.max_dpd_6m_pl > 0 %}risk{% else %}safe{% endif %}">
                    {{ tl_features.max_dpd_6m_pl if tl_features.max_dpd_6m_pl is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>Max DPD 9M (CC)</label>
                <div class="value {% if tl_features.max_dpd_9m_cc is not none and tl_features.max_dpd_9m_cc > 0 %}risk{% else %}safe{% endif %}">
                    {{ tl_features.max_dpd_9m_cc if tl_features.max_dpd_9m_cc is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>Months Since Last 0+ DPD (Unsecured)</label>
                <div class="value">{{ "%.2f"|format(tl_features.months_since_last_0p_uns) if tl_features.months_since_last_0p_uns is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Months Since Last 0+ DPD (PL)</label>
                <div class="value">{{ "%.2f"|format(tl_features.months_since_last_0p_pl) if tl_features.months_since_last_0p_pl is not none else "N/A" }}</div>
            </div>
        </div>

        <h4 style="color: #2c3e50; margin: 15px 0 8px 0; font-size: 14px;">Payment Behavior</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>% 0+ DPD in 24M (All)</label>
                <div class="value {% if tl_features.pct_0plus_24m_all is not none and tl_features.pct_0plus_24m_all > 0 %}risk{% else %}safe{% endif %}">
                    {{ "%.2f"|format(tl_features.pct_0plus_24m_all) if tl_features.pct_0plus_24m_all is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>% 0+ DPD in 24M (PL)</label>
                <div class="value {% if tl_features.pct_0plus_24m_pl is not none and tl_features.pct_0plus_24m_pl > 0 %}risk{% else %}safe{% endif %}">
                    {{ "%.2f"|format(tl_features.pct_0plus_24m_pl) if tl_features.pct_0plus_24m_pl is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>% Missed Payments (18M)</label>
                <div class="value {% if tl_features.pct_missed_payments_18m is not none and tl_features.pct_missed_payments_18m > 0 %}risk{% else %}safe{% endif %}">
                    {{ "%.2f"|format(tl_features.pct_missed_payments_18m) if tl_features.pct_missed_payments_18m is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>% Trades 0+ DPD in 12M (All)</label>
                <div class="value">{{ "%.2f"|format(tl_features.pct_trades_0plus_12m) if tl_features.pct_trades_0plus_12m is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Ratio Good Closed Loans (PL)</label>
                <div class="value {% if tl_features.ratio_good_closed_pl is not none and tl_features.ratio_good_closed_pl >= 0.8 %}safe{% elif tl_features.ratio_good_closed_pl is not none and tl_features.ratio_good_closed_pl < 0.5 %}risk{% endif %}">
                    {{ "%.0f%%"|format(tl_features.ratio_good_closed_pl * 100) if tl_features.ratio_good_closed_pl is not none else "N/A" }}
                </div>
            </div>
        </div>

        <h4 style="color: #2c3e50; margin: 15px 0 8px 0; font-size: 14px;">Utilization</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>CC Balance Utilization %</label>
                <div class="value {% if tl_features.cc_balance_utilization_pct is not none and tl_features.cc_balance_utilization_pct > 75 %}risk{% elif tl_features.cc_balance_utilization_pct is not none and tl_features.cc_balance_utilization_pct <= 30 %}safe{% endif %}">
                    {{ "%.2f"|format(tl_features.cc_balance_utilization_pct) if tl_features.cc_balance_utilization_pct is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>PL Balance Remaining %</label>
                <div class="value">{{ "%.2f"|format(tl_features.pl_balance_remaining_pct) if tl_features.pl_balance_remaining_pct is not none else "N/A" }}</div>
            </div>
        </div>

        <h4 style="color: #2c3e50; margin: 15px 0 8px 0; font-size: 14px;">Enquiry Behavior</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>Unsecured Enquiries (12M)</label>
                <div class="value {% if tl_features.unsecured_enquiries_12m is not none and tl_features.unsecured_enquiries_12m > 10 %}risk{% elif tl_features.unsecured_enquiries_12m is not none and tl_features.unsecured_enquiries_12m <= 3 %}safe{% endif %}">
                    {{ tl_features.unsecured_enquiries_12m if tl_features.unsecured_enquiries_12m is not none else "N/A" }}
                </div>
            </div>
            <div class="info-item">
                <label>Trade-to-Enquiry Ratio (Unsec 24M)</label>
                <div class="value">{{ "%.2f"|format(tl_features.trade_to_enquiry_ratio_uns_24m) if tl_features.trade_to_enquiry_ratio_uns_24m is not none else "N/A" }}</div>
            </div>
        </div>

        <h4 style="color: #2c3e50; margin: 15px 0 8px 0; font-size: 14px;">Loan Acquisition Velocity</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>Interpurchase Time 12M (PL/BL)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_12m_plbl) if tl_features.interpurchase_time_12m_plbl is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Interpurchase Time 6M (PL/BL)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_6m_plbl) if tl_features.interpurchase_time_6m_plbl is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Interpurchase Time 24M (All)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_24m_all) if tl_features.interpurchase_time_24m_all is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Interpurchase Time 9M (HL/LAP)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_9m_hl_lap) if tl_features.interpurchase_time_9m_hl_lap is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Interpurchase Time 24M (HL/LAP)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_24m_hl_lap) if tl_features.interpurchase_time_24m_hl_lap is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Interpurchase Time 24M (TWL)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_24m_twl) if tl_features.interpurchase_time_24m_twl is not none else "N/A" }}</div>
            </div>
            <div class="info-item">
                <label>Interpurchase Time 12M (Consumer Loan)</label>
                <div class="value">{{ "%.2f"|format(tl_features.interpurchase_time_12m_cl) if tl_features.interpurchase_time_12m_cl is not none else "N/A" }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    {# Bureau data not available #}
    <div class="section">
        <div class="absence-note">
            Bureau tradeline data is not available for this customer.
        </div>
    </div>
    {% endif %}

    {# ================================================================== #}
    {# DIVIDER                                                             #}
    {# ================================================================== #}

    <div class="section-divider">Banking / Transaction Report</div>

    {# ================================================================== #}
    {# PART 2: BANKING / TRANSACTION REPORT                               #}
    {# ================================================================== #}

    {% if customer_report %}

    <!-- Relationship Profile (from tl_features) -->
    {% if tl_features %}
    <div class="section">
        <h3>Relationship Profile</h3>
        <div class="info-grid">
            {% if tl_features.ktk_rel %}
            <div class="info-item">
                <label>Relationship</label>
                <div class="value">{{ tl_features.ktk_rel }}</div>
            </div>
            {% endif %}
            {% if tl_features.customer_segment %}
            <div class="info-item">
                <label>Segment</label>
                <div class="value">{{ tl_features.customer_segment|segment }}</div>
            </div>
            {% endif %}
            {% if tl_features.bank_grp %}
            <div class="info-item">
                <label>Banking Group</label>
                <div class="value">{{ tl_features.bank_grp }}</div>
            </div>
            {% endif %}
            {% if tl_features.bu_grp %}
            <div class="info-item">
                <label>Bureau Group</label>
                <div class="value">{{ tl_features.bu_grp }}</div>
            </div>
            {% endif %}
            {% if tl_features.affluence_amt is not none or tl_features.income_source %}
            <div class="info-item">
                <label>Affluence Amount</label>
                <div class="value">{% if tl_features.affluence_amt is not none %}INR {{ tl_features.affluence_amt|inr_units }}{% else %}N/A{% endif %}</div>
                {% if tl_features.income_source %}<div style="font-size: 12px; color: #666; margin-top: 3px;">{{ tl_features.income_source }}</div>{% endif %}
            </div>
            {% endif %}
            {% if tl_features.node %}
            <div class="info-item">
                <label>Customer Persona</label>
                <div class="value">{{ tl_features.node|segment }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if customer_report.customer_persona %}
    <div class="section">
        <h3>Customer Profile</h3>
        <div class="summary-box">
            <p>{{ customer_report.customer_persona }}</p>
        </div>
    </div>
    {% endif %}

    {% if customer_report.customer_review %}
    <div class="section">
        <h3>Executive Summary</h3>
        <div class="summary-box">
            <p>{{ customer_report.customer_review }}</p>
        </div>
    </div>
    {% endif %}

    {% if customer_report.salary %}
    <div class="section">
        <h3>Salary Information</h3>
        <div class="info-grid-2">
            <div class="info-item">
                <label>Average Amount</label>
                <div class="value">{{ "{:,.2f}".format(customer_report.salary.avg_amount) }} {{ customer_report.meta.currency }}</div>
            </div>
            <div class="info-item">
                <label>Transactions</label>
                <div class="value">{{ customer_report.salary.frequency }}</div>
            </div>
        </div>
        {% if customer_report.salary.narration %}
        <p style="margin-top: 10px; color: #666; font-size: 12px;">
            <strong>Sample:</strong> {{ customer_report.salary.narration[:80] }}{% if customer_report.salary.narration|length > 80 %}...{% endif %}
        </p>
        {% endif %}
    </div>
    {% endif %}

    {% if rg_salary_data %}
    <div class="section">
        <h3>Internal Salary Analysis</h3>

        {% if rg_salary_data.rg_sal %}
        <h4 style="color: #2c3e50; font-size: 14px; margin-bottom: 8px;">RG SAL</h4>
        <div class="summary-box">
            <p>{{ rg_salary_data.rg_sal.observation }}</p>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Narration</th>
                    <th class="amount">Amount (INR)</th>
                </tr>
            </thead>
            <tbody>
                {% for txn in rg_salary_data.rg_sal.transactions %}
                <tr>
                    <td>{{ txn.date }}</td>
                    <td>{{ txn.narration[:60] }}{% if txn.narration|length > 60 %}...{% endif %}</td>
                    <td class="amount positive">{{ "{:,.0f}".format(txn.amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if rg_salary_data.rg_income %}
        <h4 style="color: #2c3e50; font-size: 14px; margin-top: 18px; margin-bottom: 8px;">RG Income</h4>
        <div class="summary-box">
            <p>{{ rg_salary_data.rg_income.observation }}</p>
        </div>
        {% for src in rg_salary_data.rg_income.sources %}
        <p style="margin-top: 12px; margin-bottom: 6px; font-weight: 600; color: #2c3e50; font-size: 13px;">
            {{ src.merchant }} &mdash; {{ src.count }} transaction{{ 's' if src.count != 1 else '' }}, Total: INR {{ "{:,.0f}".format(src.total) }}
        </p>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Narration</th>
                    <th class="amount">Amount (INR)</th>
                </tr>
            </thead>
            <tbody>
                {% for txn in src.transactions %}
                <tr>
                    <td>{{ txn.date }}</td>
                    <td>{{ txn.narration[:60] }}{% if txn.narration|length > 60 %}...{% endif %}</td>
                    <td class="amount positive">{{ "{:,.0f}".format(txn.amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
        {% endif %}
    </div>
    {% endif %}

    {% if customer_report.category_overview %}
    <div class="section">
        <h3>Spending by Category</h3>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th class="amount">Amount ({{ customer_report.meta.currency }})</th>
                </tr>
            </thead>
            <tbody>
                {% for cat, amount in customer_report.category_overview.items()|sort(attribute='1', reverse=true) %}
                <tr>
                    <td>{{ cat }}</td>
                    <td class="amount">{{ "{:,.2f}".format(amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if customer_report.monthly_cashflow %}
    <div class="section">
        <h3>Monthly Cash Flow</h3>
        <table>
            <thead>
                <tr>
                    <th>Month</th>
                    <th class="amount">Inflow</th>
                    <th class="amount">Outflow</th>
                    <th class="amount">Net</th>
                </tr>
            </thead>
            <tbody>
                {% for m in customer_report.monthly_cashflow %}
                <tr>
                    <td>{{ m.month }}</td>
                    <td class="amount positive">{{ "{:,.0f}".format(m.inflow) }}</td>
                    <td class="amount negative">{{ "{:,.0f}".format(m.outflow) }}</td>
                    <td class="amount {% if m.net >= 0 %}positive{% else %}negative{% endif %}">
                        {{ "{:,.0f}".format(m.net) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if customer_report.emis %}
    <div class="section">
        <h3>EMI Payments</h3>
        <table>
            <thead>
                <tr>
                    <th>Description</th>
                    <th class="amount">Average Amount</th>
                    <th class="amount">Transactions</th>
                </tr>
            </thead>
            <tbody>
                {% for emi in customer_report.emis %}
                <tr>
                    <td>{{ emi.name }}</td>
                    <td class="amount">{{ "{:,.2f}".format(emi.amount) }}</td>
                    <td class="amount">{{ emi.frequency }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if customer_report.rent %}
    <div class="section">
        <h3>Rent Payments</h3>
        <div class="info-grid">
            <div class="info-item">
                <label>Direction</label>
                <div class="value">{{ customer_report.rent.direction | capitalize }}</div>
            </div>
            <div class="info-item">
                <label>Average Amount</label>
                <div class="value">{{ "{:,.2f}".format(customer_report.rent.amount) }} {{ customer_report.meta.currency }}</div>
            </div>
            <div class="info-item">
                <label>Transactions</label>
                <div class="value">{{ customer_report.rent.frequency }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if customer_report.bills %}
    <div class="section">
        <h3>Utility Bills</h3>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th class="amount">Average Amount</th>
                    <th class="amount">Transactions</th>
                </tr>
            </thead>
            <tbody>
                {% for bill in customer_report.bills %}
                <tr>
                    <td>{{ bill.bill_type }}</td>
                    <td class="amount">{{ "{:,.2f}".format(bill.avg_amount) }}</td>
                    <td class="amount">{{ bill.frequency }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if customer_report.top_merchants %}
    <div class="section">
        <h3>Top Merchants</h3>
        <table>
            <thead>
                <tr>
                    <th>Merchant</th>
                    <th class="amount">Transactions</th>
                    <th class="amount">Total ({{ customer_report.meta.currency }})</th>
                </tr>
            </thead>
            <tbody>
                {% for m in customer_report.top_merchants %}
                <tr>
                    <td>{{ m.name[:40] }}{% if m.name|length > 40 %}...{% endif %}</td>
                    <td class="amount">{{ m.count }}</td>
                    <td class="amount">{{ "{:,.0f}".format(m.total) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% else %}
    {# Banking data not available #}
    <div class="section">
        <div class="absence-note">
            Banking transaction data is not available for this customer.
        </div>
    </div>
    {% endif %}

    {# ================================================================== #}
    {# PART 3: COMBINED EXECUTIVE SUMMARY                                  #}
    {# ================================================================== #}

    {% if combined_summary %}
    <div class="section-divider">Combined Executive Summary</div>
    <div class="section">
        <div class="summary-box" style="border-left: 4px solid #2c3e50;">
            <p>{{ combined_summary }}</p>
        </div>
    </div>
    {% endif %}

    <div class="footer">
        {% if customer_report %}
        <p>Generated on {{ customer_report.meta.generated_at[:10] }} | Currency: {{ customer_report.meta.currency }}</p>
        {% elif bureau_report %}
        <p>Generated on {{ bureau_report.meta.generated_at[:10] }}</p>
        {% endif %}
    </div>
</body>
</html>
